{
    "collab_server" : "",
    "contents" : "CalcularCalidadTasacion <- function(CasoA_Estimar, Muestra, MuestraSeleccionada, Coeficientes, CasoTransformado){\n\n  ColumnaDependienteDeTipologia <-  ifelse(\"NumeroDeDormitorios\" %in% colnames(CasoTransformado),\n                                           \"NumeroDeDormitorios\",\n                                           \"SuperficieDeLaParcela\")\n  CasoTransformado <- CasoTransformado[,c(\"NumeroDeBanos\",\n                                         ColumnaDependienteDeTipologia,\n                                         \"SuperficieConstruidaDeLaVivienda\",\n                                         \"CosteDeConstruccionBrutoUnitarioVivienda\", \n                                         \"PorcentajeDepreciacionVivienda\")]\n  MuestraCalidad <- Muestra[,c(\"NumeroDeBanos\",\n                               ColumnaDependienteDeTipologia,\n                               \"SuperficieConstruidaDeLaVivienda\",\n                               \"CosteDeConstruccionBrutoUnitarioVivienda\", \n                               \"PorcentajeDepreciacionVivienda\")]\n  MuestraCalidad <- rbind(CasoTransformado, MuestraCalidad)\n  MuestraCalidadEstandarizada <- scale(MuestraCalidad, center = TRUE, scale = TRUE)[,c(1:5)]\n  MuestraCalidadEstandarizada[is.nan(MuestraCalidadEstandarizada)] <- 0\n  MuestraCalidadEstandarizada <- \n    cbind(MuestraCalidadEstandarizada, Muestra[,\"Pesos\"][match(rownames(MuestraCalidadEstandarizada),rownames(Muestra))])\n  colnames(MuestraCalidadEstandarizada)[6] <- \"Pesos\"\n  CalculoCentroDeGravedad <- MuestraCalidadEstandarizada[,1:5] * MuestraCalidadEstandarizada[,\"Pesos\"]\n  CalculoNivelConfianza <- CalculoCentroDeGravedad\n  PesoTotal <- sum(Muestra[,\"Pesos\"][match(rownames(Muestra), rownames(MuestraSeleccionada))], na.rm = TRUE)\n  CentroDeGravedad <- colSums(subset(CalculoCentroDeGravedad, rownames(CalculoCentroDeGravedad) %in% rownames(MuestraSeleccionada)))/PesoTotal\n  if(!is.na(CasoA_Estimar$NumeroDeBanos))\n  {\n    CalculoNivelConfianza[,\"NumeroDeBanos\"] <- (CentroDeGravedad[\"NumeroDeBanos\"] - MuestraCalidadEstandarizada[,\"NumeroDeBanos\"])^2\n  } else {\n    CalculoNivelConfianza[,\"NumeroDeBanos\"] <- 0\n  }\n  \n  if(is.na(CasoA_Estimar[,ColumnaDependienteDeTipologia]))\n  {\n    CalculoNivelConfianza[,ColumnaDependienteDeTipologia] <- 0\n    \n  } else {\n    CalculoNivelConfianza[,ColumnaDependienteDeTipologia] <- (CentroDeGravedad[ColumnaDependienteDeTipologia] - MuestraCalidadEstandarizada[,ColumnaDependienteDeTipologia])^2\n  }\n  \n  if(!is.na(CasoA_Estimar$SuperficieConstruidaDeLaVivienda))\n  {\n    CalculoNivelConfianza[,\"SuperficieConstruidaDeLaVivienda\"] <- (CentroDeGravedad[\"SuperficieConstruidaDeLaVivienda\"] - MuestraCalidadEstandarizada[,\"SuperficieConstruidaDeLaVivienda\"])^2\n  } else {\n    CalculoNivelConfianza[,\"SuperficieConstruidaDeLaVivienda\"] <- 0\n  }\n  \n  if(!is.na(CasoA_Estimar$CosteDeConstruccionBrutoUnitarioVivienda))\n  {\n    CalculoNivelConfianza[,\"CosteDeConstruccionBrutoUnitarioVivienda\"] <- (CentroDeGravedad[\"CosteDeConstruccionBrutoUnitarioVivienda\"] - MuestraCalidadEstandarizada[,\"CosteDeConstruccionBrutoUnitarioVivienda\"])^2\n  } else {\n    CalculoNivelConfianza[,\"CosteDeConstruccionBrutoUnitarioVivienda\"] <- 0\n  }\n  \n  if(!is.na(CasoA_Estimar$PorcentajeDepreciacionVivienda))\n  {\n    CalculoNivelConfianza[,\"PorcentajeDepreciacionVivienda\"] <- (CentroDeGravedad[\"PorcentajeDepreciacionVivienda\"] - MuestraCalidadEstandarizada[,\"PorcentajeDepreciacionVivienda\"])^2\n  } else {\n    CalculoNivelConfianza[,\"PorcentajeDepreciacionVivienda\"] <- 0\n  }\n  \n  d <- sqrt(rowSums(CalculoNivelConfianza %*% diag(Coeficientes[1:5])))\n  dxPesos <- d * MuestraCalidadEstandarizada[,\"Pesos\"]\n  dCuadradoxPesos <- d^2 * MuestraCalidadEstandarizada[,\"Pesos\"]\n  SumaDePesosxW <- sum(subset(dxPesos, names(dxPesos) %in% rownames(MuestraSeleccionada)))\n  SumaDePesosCuadradoxW <- sum(subset(dCuadradoxPesos, names(dxPesos) %in% rownames(MuestraSeleccionada)))\n  MediaPesos <- SumaDePesosxW/PesoTotal\n  MediaCuadradoPesos <- SumaDePesosCuadradoxW/PesoTotal\n  DesviacionTipica <- sqrt(PesoTotal*(MediaCuadradoPesos-MediaPesos^2)/(PesoTotal-1))\n  CalidadEstudio <- (d[\"CasoTransformado\"]-MediaPesos)/DesviacionTipica\n  names(CalidadEstudio) <- \"CalidadEstudio\"\n  CalidadEstudioAlfa <- ifelse (CalidadEstudio < 0, \"Muy bueno\", \n          ifelse (CalidadEstudio >= 0 && CalidadEstudio <= 1, \"Bueno\", \n                  ifelse (CalidadEstudio > 1 && CalidadEstudio <= 2, \"Regular\",\"Malo\")))\n  names(CalidadEstudioAlfa) <- \"CalidadEstudioAlfa\"\n  c(CalidadEstudio, CalidadEstudioAlfa)\n}",
    "created" : 1496747231955.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1473262681",
    "id" : "EA4E4CCC",
    "lastKnownWriteTime" : 1471515223,
    "last_content_update" : 1471515223,
    "path" : "C:/Users/TBG/Desktop/stima2/stima-r - copia/stima-r/Tasacion/R/CalcularCalidadTasacion.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}